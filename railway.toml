# Railway Production Configuration
# This file configures the production deployment for Railway

# Build configuration
[build]
builder = "nixpacks"
buildCommand = "CI=true pnpm install --no-frozen-lockfile --force && pnpm build"

# Deploy configuration
[deploy]
# startCommand is set in Dockerfile CMD - Railway will use Dockerfile CMD when Dockerfile is present
restartPolicyType = "always"

[services.ai-visibility-api.deploy]
healthcheckPath = "/healthz"
healthcheckTimeout = 300

[services.ai-visibility-jobs.deploy]
# Disable HTTP healthcheck for the worker; it does not expose an HTTP server.
healthcheckPath = ""
# Use Dockerfile for jobs service to ensure proper build process
dockerfilePath = "apps/jobs/Dockerfile"

# Environment variables
[env]
NODE_ENV = "production"
PORT = "8080"
CI = "true"  # Enable CI mode to skip all interactive prompts during pnpm install
PNPM_FORCE = "true"  # Skip confirmation prompts during install

[services.ai-visibility-platform.env]
REDIS_URL = "${{ Redis.REDIS_URL }}"
REDIS_HOST = "redis.railway.internal"
REDIS_PORT = "6379"
REDIS_PASSWORD = "${{ Redis.REDIS_PASSWORD }}"

[services.ai-visibility-jobs.env]
REDIS_URL = "${{ Redis.REDIS_URL }}"
REDIS_HOST = "redis.railway.internal"
REDIS_PORT = "6379"
REDIS_PASSWORD = "${{ Redis.REDIS_PASSWORD }}"
CI = "true"  # Enable CI mode to skip all interactive prompts during pnpm install
PNPM_FORCE = "true"  # Skip confirmation prompts during install

# Scaling configuration
[scale]
minInstances = 1
maxInstances = 10
targetConcurrency = 100

# Networking
[networking]
internalPort = 8080  # Must match PORT environment variable
externalPort = 443
protocol = "https"

# Health checks
# Logging
[logging]
level = "info"
format = "json"

# Monitoring
[monitoring]
enabled = true
metrics = true
tracing = true

